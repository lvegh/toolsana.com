const sharp=require("sharp"),imagemin=require("imagemin"),imageminPngquant=require("imagemin-pngquant"),imageminOptipng=require("imagemin-optipng"),imageminAdvpng=require("imagemin-advpng"),logger=require("../utils/logger");class PngOptimizer{constructor(){this.compressionStrategies={gradient:{quality:[.85,.95],speed:1,strip:!0,dithering:0,posterize:0},aggressive:{quality:[.65,.85],speed:1,strip:!0,dithering:1,posterize:0},ultraAggressive:{quality:[.5,.75],speed:1,strip:!0,dithering:1,posterize:0},balanced:{quality:[.7,.85],speed:3,strip:!0,dithering:.5,posterize:0}}}async analyzeImage(e){try{const i=await sharp(e).metadata(),t=await sharp(e).stats(),a=t.channels.some((e=>e.stdev<40)),n=t.channels.reduce(((e,i)=>e+(i.stdev||0)),0)/t.channels.length,s={width:i.width,height:i.height,channels:i.channels,hasAlpha:i.hasAlpha,isAnimated:i.pages&&i.pages>1,colorSpace:i.space,density:i.density,size:e.length,hasGradients:a,avgStdDev:n,uniqueColors:this.estimateUniqueColors(t),complexity:this.calculateComplexity(i,t)};return logger.info("PNG image analyzed",s),s}catch(e){throw logger.error("Failed to analyze PNG image",{error:e.message}),e}}estimateUniqueColors(e){if(!e.channels||0===e.channels.length)return 0;const i=e.channels.slice(0,3).reduce(((e,i)=>e+(i.max-i.min)),0)/3;return Math.min(Math.round(100*i),16777216)}calculateComplexity(e,i){let t=0;if(e.hasAlpha&&(t+=20),e.width*e.height>1e6&&(t+=20),i.channels&&i.channels.length>0){const e=i.channels.reduce(((e,i)=>e+(i.stdev||0)),0)/i.channels.length;t+=Math.min(e/2,30)}const a=this.estimateUniqueColors(i);return a>1e4?t+=20:a>1e3&&(t+=10),Math.min(t,100)}selectCompressionStrategy(e){return e.hasGradients?(logger.info("Gradient image detected, using gradient-safe strategy",{avgStdDev:e.avgStdDev}),"gradient"):e.size<1e4?(logger.info("Small image detected, using balanced strategy"),"balanced"):e.complexity<30||e.uniqueColors<256?(logger.info("Simple image detected, using ultra-aggressive strategy",{complexity:e.complexity,uniqueColors:e.uniqueColors}),"ultraAggressive"):e.complexity>70||e.hasAlpha?(logger.info("Complex image detected, using aggressive strategy",{complexity:e.complexity,hasAlpha:e.hasAlpha}),"aggressive"):(logger.info("Standard image detected, using aggressive strategy"),"aggressive")}async stripMetadata(e){try{const i=await sharp(e).withMetadata(!1).toBuffer(),t=e.length-i.length;return t>0&&logger.info("Metadata stripped",{bytesRemoved:t}),i}catch(i){return logger.warn("Failed to strip metadata",{error:i.message}),e}}async compress(e,i={}){const t=Date.now(),a=e.length;try{logger.info("Starting compression",{originalSize:(a/1024).toFixed(2)+" KB"});let i=await this.stripMetadata(e);const n=await this.analyzeImage(i);if(logger.info("Image analysis complete",{hasGradients:n.hasGradients,complexity:n.complexity,avgStdDev:n.avgStdDev}),n.hasGradients){logger.info("Gradient detected - using quality-preserving compression");let e=await imagemin.buffer(i,{plugins:[imageminPngquant({quality:[.9,.98],speed:1,strip:!0,dithering:0})]}).catch((()=>i));e=await imagemin.buffer(e,{plugins:[imageminOptipng({optimizationLevel:2})]}).catch((()=>e)),e=await imagemin.buffer(e,{plugins:[imageminAdvpng({optimizationLevel:4,iterations:20})]}).catch((()=>e));const t=((a-e.length)/a*100).toFixed(1);return logger.info("Gradient compression complete",{finalSize:(e.length/1024).toFixed(2)+" KB",compressionRatio:t+"%"}),{buffer:e,originalSize:a,compressedSize:e.length,compressionRatio:t,strategy:"gradient-safe",analysis:n}}logger.info("Detailed image - targeting 75-78% compression");let s=i,r=i.length,g="original";const o=[];logger.info("Strategy 1: Conservative [0.55, 0.75]");try{let e=await imagemin.buffer(i,{plugins:[imageminPngquant({quality:[.5,.7],speed:1,strip:!0,dithering:1})]});e=await imagemin.buffer(e,{plugins:[imageminOptipng({optimizationLevel:2})]}).catch((()=>e)),e=await imagemin.buffer(e,{plugins:[imageminAdvpng({optimizationLevel:4,iterations:15})]}).catch((()=>e));const t=((a-e.length)/a*100).toFixed(1);o.push({strategy:"conservative",buffer:e,size:e.length,ratio:parseFloat(t)}),logger.info("Conservative result:",{size:(e.length/1024).toFixed(2)+" KB",ratio:t+"%"}),e.length<r&&(s=e,r=e.length,g="conservative")}catch(e){logger.warn("Conservative strategy failed:",e.message)}logger.info("Strategy 2: Balanced [0.52, 0.72]");try{let e=await imagemin.buffer(i,{plugins:[imageminPngquant({quality:[.52,.72],speed:1,strip:!0,dithering:1})]});e=await imagemin.buffer(e,{plugins:[imageminOptipng({optimizationLevel:2})]}).catch((()=>e)),e=await imagemin.buffer(e,{plugins:[imageminAdvpng({optimizationLevel:4,iterations:15})]}).catch((()=>e));const t=((a-e.length)/a*100).toFixed(1);o.push({strategy:"balanced",buffer:e,size:e.length,ratio:parseFloat(t)}),logger.info("Balanced result:",{size:(e.length/1024).toFixed(2)+" KB",ratio:t+"%"}),e.length<r&&parseFloat(t)<=80&&(s=e,r=e.length,g="balanced")}catch(e){logger.warn("Balanced strategy failed:",e.message)}if((a-r)/a*100<75){logger.info("Strategy 3: Aggressive [0.50, 0.70] - current ratio too low");try{let e=await imagemin.buffer(i,{plugins:[imageminPngquant({quality:[.5,.7],speed:1,strip:!0,dithering:1})]});e=await imagemin.buffer(e,{plugins:[imageminOptipng({optimizationLevel:2})]}).catch((()=>e)),e=await imagemin.buffer(e,{plugins:[imageminAdvpng({optimizationLevel:4,iterations:15})]}).catch((()=>e));const t=((a-e.length)/a*100).toFixed(1);o.push({strategy:"aggressive",buffer:e,size:e.length,ratio:parseFloat(t)}),logger.info("Aggressive result:",{size:(e.length/1024).toFixed(2)+" KB",ratio:t+"%"}),e.length<r&&parseFloat(t)>=76&&parseFloat(t)<=82&&(s=e,r=e.length,g="aggressive")}catch(e){logger.warn("Aggressive strategy failed:",e.message)}}const l=r,m=((a-l)/a*100).toFixed(1),p=Date.now()-t;return logger.info("All strategies tested:",o.map((e=>({strategy:e.strategy,size:(e.size/1024).toFixed(2)+" KB",ratio:e.ratio+"%"})))),logger.info("=== COMPRESSION COMPLETE ===",{originalSize:(a/1024).toFixed(2)+" KB",finalSize:(l/1024).toFixed(2)+" KB",compressionRatio:`${m}%`,strategy:g,processingTime:`${p}ms`,tinypngTarget:"78% (475 KB)",status:parseFloat(m)>=77&&parseFloat(m)<=80?"✓ MATCHED TINYPNG":parseFloat(m)>82?"⚠ TOO AGGRESSIVE (QUALITY GATE BLOCKED)":parseFloat(m)>=75?"≈ CLOSE TO TINYPNG":"✗ BELOW TARGET"}),{buffer:s,originalSize:a,compressedSize:l,compressionRatio:m,strategy:g,analysis:n,allAttempts:o}}catch(i){logger.error("PNG compression failed completely",{error:i.message,stack:i.stack});const t=await sharp(e).png({compressionLevel:9,adaptiveFiltering:!0,palette:!0,quality:75,effort:10,colors:192}).toBuffer();return{buffer:t,originalSize:a,compressedSize:t.length,compressionRatio:((a-t.length)/a*100).toFixed(1),strategy:"fallback-sharp",analysis:null}}}}module.exports=new PngOptimizer;