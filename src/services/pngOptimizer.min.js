const sharp=require("sharp"),imagemin=require("imagemin"),imageminPngquant=require("imagemin-pngquant"),imageminOptipng=require("imagemin-optipng"),imageminAdvpng=require("imagemin-advpng"),logger=require("../utils/logger");class PngOptimizer{constructor(){this.compressionStrategies={aggressive:{quality:[.3,.5],speed:1,strip:!0,dithering:1},balanced:{quality:[.5,.7],speed:3,strip:!0,dithering:.75},quality:{quality:[.7,.9],speed:5,strip:!0,dithering:.5}}}async analyzeImage(e){try{const i=await sharp(e).metadata(),t=await sharp(e).stats(),n={width:i.width,height:i.height,channels:i.channels,hasAlpha:i.hasAlpha,isAnimated:i.pages&&i.pages>1,colorSpace:i.space,density:i.density,size:e.length,uniqueColors:this.estimateUniqueColors(t),complexity:this.calculateComplexity(i,t)};return logger.info("PNG image analyzed",n),n}catch(e){throw logger.error("Failed to analyze PNG image",{error:e.message}),e}}estimateUniqueColors(e){if(!e.channels||0===e.channels.length)return 0;const i=e.channels.slice(0,3).reduce(((e,i)=>e+(i.max-i.min)),0)/3;return Math.min(Math.round(100*i),16777216)}calculateComplexity(e,i){let t=0;if(e.hasAlpha&&(t+=20),e.width*e.height>1e6&&(t+=20),i.channels&&i.channels.length>0){const e=i.channels.reduce(((e,i)=>e+(i.stdev||0)),0)/i.channels.length;t+=Math.min(e/2,30)}const n=this.estimateUniqueColors(i);return n>1e4?t+=20:n>1e3&&(t+=10),Math.min(t,100)}selectCompressionStrategy(e){return e.size<1e4?(logger.info("Small image detected, using quality strategy"),"quality"):e.complexity<30||e.uniqueColors<256?(logger.info("Simple image detected, using aggressive strategy",{complexity:e.complexity,uniqueColors:e.uniqueColors}),"aggressive"):e.complexity>70||e.hasAlpha?(logger.info("Complex image detected, using quality strategy",{complexity:e.complexity,hasAlpha:e.hasAlpha}),"quality"):(logger.info("Standard image detected, using balanced strategy"),"balanced")}async optimizeWithPngquant(e,i){try{const t=this.compressionStrategies[i];logger.info("Starting pngquant optimization",{strategy:i,quality:t.quality,speed:t.speed});const n=await imagemin.buffer(e,{plugins:[imageminPngquant({quality:t.quality,speed:t.speed,strip:t.strip,dithering:t.dithering,posterize:4,verbose:!0})]}),a=((e.length-n.length)/e.length*100).toFixed(1);return logger.info("Pngquant optimization complete",{originalSize:e.length,optimizedSize:n.length,reduction:`${a}%`}),n}catch(i){return logger.warn("Pngquant optimization failed, returning original",{error:i.message,stack:i.stack}),e}}async optimizeWithOptipng(e){try{logger.info("Starting OptiPNG optimization");const i=await imagemin.buffer(e,{plugins:[imageminOptipng({optimizationLevel:3})]}),t=((e.length-i.length)/e.length*100).toFixed(1);return logger.info("OptiPNG optimization complete",{originalSize:e.length,optimizedSize:i.length,reduction:`${t}%`}),i}catch(i){return logger.warn("OptiPNG optimization failed, returning input",{error:i.message}),e}}async optimizeWithAdvpng(e){try{logger.info("Starting AdvPNG optimization");const i=await imagemin.buffer(e,{plugins:[imageminAdvpng({optimizationLevel:4})]}),t=((e.length-i.length)/e.length*100).toFixed(1);return logger.info("AdvPNG optimization complete",{originalSize:e.length,optimizedSize:i.length,reduction:`${t}%`}),i}catch(i){return logger.warn("AdvPNG optimization failed, returning input",{error:i.message}),e}}async optimizeWithSharp(e){try{logger.info("Starting Sharp optimization (fallback)");const i=await sharp(e).png({compressionLevel:9,adaptiveFiltering:!0,palette:!0,quality:90,effort:10}).toBuffer(),t=((e.length-i.length)/e.length*100).toFixed(1);return logger.info("Sharp optimization complete",{originalSize:e.length,optimizedSize:i.length,reduction:`${t}%`}),i}catch(e){throw logger.error("Sharp optimization failed",{error:e.message}),e}}async stripMetadata(e){try{const i=await sharp(e).withMetadata(!1).toBuffer(),t=e.length-i.length;return t>0&&logger.info("Metadata stripped",{bytesRemoved:t}),i}catch(i){return logger.warn("Failed to strip metadata",{error:i.message}),e}}async compress(e,i={}){const t=Date.now(),n=e.length;try{let i=await this.stripMetadata(e);const a=await this.analyzeImage(i);logger.info("Applying aggressive pngquant compression");const r=await imagemin.buffer(i,{plugins:[imageminPngquant({quality:[.3,.7],speed:1,strip:!0,dithering:.8,posterize:2})]}).catch((e=>(logger.warn("Pngquant failed, continuing with original",{error:e.message}),i)));r.length<i.length&&(i=r,logger.info("Pngquant reduced size",{before:i.length,after:r.length,reduction:((i.length-r.length)/i.length*100).toFixed(1)+"%"})),logger.info("Applying OptiPNG optimization");const g=await imagemin.buffer(i,{plugins:[imageminOptipng({optimizationLevel:7})]}).catch((e=>(logger.warn("OptiPNG failed, continuing",{error:e.message}),i)));g.length<i.length&&(i=g,logger.info("OptiPNG reduced size further")),logger.info("Applying AdvPNG optimization");const o=await imagemin.buffer(i,{plugins:[imageminAdvpng({optimizationLevel:4,iterations:10})]}).catch((e=>(logger.warn("AdvPNG failed, continuing",{error:e.message}),i)));if(o.length<i.length&&(i=o,logger.info("AdvPNG reduced size further")),i.length>.5*n){logger.info("Trying ultra-aggressive compression");const t=await imagemin.buffer(e,{plugins:[imageminPngquant({quality:[.2,.5],speed:1,strip:!0,dithering:1,posterize:1})]}).catch((()=>i));t.length<i.length&&(i=t,logger.info("Ultra-aggressive compression achieved better results"))}const s=i.length,l=((n-s)/n*100).toFixed(1),p=Date.now()-t;return logger.info("PNG compression completed",{originalSize:n,finalSize:s,compressionRatio:`${l}%`,processingTime:`${p}ms`}),{buffer:i,originalSize:n,compressedSize:s,compressionRatio:l,strategy:"intelligent-auto",analysis:a}}catch(i){logger.error("PNG compression failed, using Sharp fallback",{error:i.message,stack:i.stack});const t=await sharp(e).png({compressionLevel:9,adaptiveFiltering:!0,palette:!0,quality:60,effort:10,colors:256}).toBuffer();return{buffer:t,originalSize:n,compressedSize:t.length,compressionRatio:((n-t.length)/n*100).toFixed(1),strategy:"fallback-sharp",analysis:null}}}}module.exports=new PngOptimizer;